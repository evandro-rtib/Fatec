/*
Create  table TabLog

(datalog date,

campo1 varchar2(60),

campo2 varchar2(80));

Create OR REPLACE  Tab_erro

( dataerro date,

mensagem varchar2(50));

create table tb_cliente
( codcliente number(5) not null,
  nomecliente varchar2(30) not null,
  endereco varchar2(30),
  cidade varchar2(20),
  cep varchar2(10),
  uf char(2));


create table tb_vendedor
( codvendedor number(5) not null,
  nomevendedor varchar2(30) not null,
  faixa_com    number(4,2),
  salario_fixo number(7,2));


create table tb_produto
( codproduto   number(5) not null,
  descricao varchar(20),
  unid       char(2),
  valor_unit number(6,2));

Create table TB_PEDIDO

( NUMPEDIDO     number(5) NOT NULL,
  PRAZO_ENTREGA DATE,
  CODCLIENTE     number(5),
  CODVENDEDOR   number(5));

CREATE TABLE TB_ITEM_PEDIDO
(NUMPEDIDO   number(5) NOT NULL,
 CODPRODUTO  number(5) NOT NULL,
 QTDE        number(5));


-- DEFININDO AS RESTRIÇÕES

-- Criando as PK´s

ALTER TABLE TB_CLIENTE 
 ADD CONSTRAINT PK_CLIENTE_CODCLIENTE PRIMARY KEY(CODCLIENTE);


ALTER TABLE TB_PRODUTO 
 ADD CONSTRAINT PK_PRODUTO_CODPRODUTO PRIMARY KEY(CODPRODUTO);
 
 
 ALTER TABLE TB_VENDEDOR 
 ADD CONSTRAINT PK_VENDEDOR_CODVENDEDOR PRIMARY KEY(CODVENDEDOR);
 

ALTER TABLE TB_PEDIDO 
 ADD CONSTRAINT PK_PEDIDO_NUMPEDIDO PRIMARY KEY(NUMPEDIDO);


ALTER TABLE TB_ITEM_PEDIDO ADD CONSTRAint  PK_ITEMPEDIDO_PEDPROD 
 PRIMARY KEY(NUMPEDIDO,CODPRODUTO);
 
 
----
ALTER TABLE TB_PEDIDO 
 ADD CONSTRAINT FK_PEDIDO_CODCLI FOREIGN KEY(CODCLIENTE) REFERENCES TB_CLIENTE;

ALTER TABLE TB_PEDIDO 
 ADD CONSTRAINT FK_PEDIDO_CODVENDEDOR FOREIGN KEY(CODVENDEDOR) REFERENCES TB_VENDEDOR;

--- ITEM PEDIDO

ALTER TABLE TB_ITEM_PEDIDO 
    ADD CONSTRAINT FK_ITEMPEDIDO_NUMPEDIDO FOREIGN KEY(NUMPEDIDO) REFERENCES TB_PEDIDO;

ALTER TABLE TB_ITEM_PEDIDO 
    ADD CONSTRAINT FK_ITEMPEDIDO_CODPRODUTO FOREIGN KEY(CODPRODUTO) REFERENCES TB_PRODUTO;

----

-- INSERINDO DADOS
insert into TB_vendedor values (5,'Antonio Pedro',5.0,400);
insert into TB_vendedor values (15,'Carlos Sola',0.0,400);
insert into tb_vendedor values (25,'Ana Carolina',1.0,200);
insert into TB_vendedor values (35,'Solange Almeida',1.0,300);


INSERT INTO TB_CLIENTE 
VALUES ( 30, 'João da Silva', 'AV. MATT HOFFMANN, 1100', 'SÃO PAULO', '97056-001', 'SP')
/

INSERT INTO TB_CLIENTE 
VALUES ( 31, 'LUCAS ANTUNES', 'RUA TRODANI, 120', 'SOROCABA', '19658-023', 'SP')
/

INSERT INTO Tb_CLIENTE 
VALUES ( 32, 'LAURA STRAUSS', 'RUA TULIPAS, 650', 'PRIMAVERA', '18556-025', 'SP')
/


INSERT INTO TB_PRODUTO 
VALUES ( 11, 'APPLE DISPLAY', 'UN', 975.99)
/

INSERT INTO TB_PRODUTO VALUES ( 12, 'IBM THINK PAD R61', 'UN', 999.70)
/

INSERT INTO TB_PRODUTO VALUES ( 13, 'PÓ PARA TONER', 'KG', 85.60)
/

INSERT INTO TB_PEDIDO VALUES ( 7, to_date('26/02/2023','dd/mm/yyyy'), 31, 15)
/

INSERT INTO TB_PEDIDO VALUES ( 8, to_date('31/03/2023','dd/mm/yyyy'), 32, 25)
/

INSERT INTO TB_PEDIDO VALUES ( 9, to_date('04/04/2023','dd/mm/yyyy'), 32, 5)
/

INSERT INTO TB_PEDIDO VALUES ( 10, to_date('10/04/2023','dd/mm/yyyy'), 30, 5)
/
INSERT INTO TB_PEDIDO VALUES ( 11, to_date('15/04/2023','dd/mm/yyyy'), 30, 5)
/
INSERT INTO TB_PEDIDO VALUES ( 12, to_date('25/04/2023','dd/mm/yyyy'), 30, 25)
/
INSERT INTO TB_PEDIDO VALUES ( 13, to_date('26/04/2023','dd/mm/yyyy'), 30, 5)
/
INSERT INTO TB_PEDIDO VALUES ( 14, to_date('27/04/2023','dd/mm/yyyy'), 30, 5)
/
INSERT INTO TB_ITEM_PEDIDO VALUES (7, 11, 3);

INSERT INTO TB_ITEM_PEDIDO VALUES (7, 12, 3);

INSERT INTO TB_ITEM_PEDIDO VALUES (8, 13, 3);
INSERT INTO TB_ITEM_PEDIDO VALUES (9, 11, 3);
INSERT INTO TB_ITEM_PEDIDO VALUES (10, 11, 3);
INSERT INTO TB_ITEM_PEDIDO VALUES (10, 12, 3);
INSERT INTO TB_ITEM_PEDIDO VALUES (10, 13, 3);
INSERT INTO TB_ITEM_PEDIDO VALUES (11, 13, 3);
INSERT INTO TB_ITEM_PEDIDO VALUES (12, 13, 3);
INSERT INTO TB_ITEM_PEDIDO VALUES (13, 13, 3);
INSERT INTO TB_ITEM_PEDIDO VALUES (14, 13, 3);


---
SELECT * FROM TB_CLIENTE;
SELECT * FROM TB_VENDEDOR;
SELECT * FROM TB_PRODUTO;
SELECT * FROM TB_PEDIDO;
SELECT * FROM TB_ITEM_PEDIDO;

--ALTERAR O TAMANHO DO CAMPO 2
CREATE OR REPLACE PROCEDURE SP_Atraso (P_PEDIDONUMERO NUMBER)
AS
    V_PEDIDONUMERO TB_PEDIDO.NUMPEDIDO%TYPE;
    V_PEDIDOPRAZOENTRAGA TB_PEDIDO.PRAZO_ENTREGA%TYPE;
    V_VENDEDORNOME TB_VENDEDOR.nomevendedoR%TYPE;
    V_DATAATUAL DATE;
BEGIN
	SELECT
    	SYSDATE
    	INTO V_DATAATUAL 
    FROM
    	DUAL;
    
	SELECT
    	PRAZO_ENTREGA
    	INTO  V_PEDIDOPRAZOENTRAGA
    FROM
    	TB_PEDIDO
    WHERE
    	NUMPEDIDO=P_PEDIDONUMERO;

	IF  V_DATAATUAL > V_PEDIDOPRAZOENTRAGA     THEN
        SELECT 
        	NOMEVENDEDOR
    		INTO V_VENDEDORNOME
        FROM 
        	TB_VENDEDOR
        WHERE 
        	CODVENDEDOR IN (SELECT CODVENDEDOR FROM TB_PEDIDO WHERE NUMPEDIDO=P_PEDIDONUMERO );
		INSERT INTO TABLOG VALUES (SYSDATE,V_VENDEDORNOME,'Pedido em atraso. O vendedor deve avisar ao cliente, NPEDIDO: ' || P_PEDIDONUMERO);
    END IF;
EXCEPTION
	WHEN NO_DATA_FOUND THEN
		INSERT INTO TAB_ERRO VALUES (SYSDATE,'NENHUM REGISTRO ENCONTRADO, NPEDIDO: ' || P_PEDIDONUMERO);
	WHEN TOO_MANY_ROWS THEN
        INSERT INTO TAB_ERRO VALUES (SYSDATE,'VERIFIQUE A CONSULTA SQL');
END;

    EXEC SP_Atraso (7);
SELECT * FROM TABLOG;
SELECT * FROM TAB_ERRO;


CREATE OR REPLACE PROCEDURE SP_ClientePremiuM (P_CLIENTECODIGO NUMBER)
AS
    V_CLIENTECODIGO TB_CLIENTE.CODCLIENTE%TYPE;
    V_NUMERO_PEDIDOS NUMBER(6);
	V_DATAATUAL DATE;
	V_CLIENTENOME TB_CLIENTE.NOMECLIENTE%TYPE;
BEGIN
	SELECT
    	SYSDATE
    	INTO V_DATAATUAL 
    FROM
    	DUAL;
    
	SELECT
    	COUNT(*)
    	INTO   V_NUMERO_PEDIDOS
    FROM
    	TB_PEDIDO
    WHERE
    	CODCLIENTE=P_CLIENTECODIGO
	AND 
        PRAZO_ENTREGA BETWEEN SYSDATE AND ADD_MONTHS(SYSDATE, 2)
	GROUP BY CODCLIENTE;

	SELECT
        NOMECLIENTE
        INTO V_CLIENTENOME
    FROM
        TB_CLIENTE
    WHERE
        CODCLIENTE = P_CLIENTECODIGO;
        
	IF  V_NUMERO_PEDIDOS > 2     THEN
        INSERT INTO TABLOG VALUES (SYSDATE,'Cliente especial - enviar brinde',concat(P_CLIENTECODIGO,' - ',V_CLIENTENOME));
    END IF;
EXCEPTION
	WHEN NO_DATA_FOUND THEN
		INSERT INTO TAB_ERRO VALUES (SYSDATE,'NENHUM REGISTRO ENCONTRADO, NCLIENTE: ' || P_CLIENTECODIGO);
	WHEN TOO_MANY_ROWS THEN
        INSERT INTO TAB_ERRO VALUES (SYSDATE,'VERIFIQUE A CONSULTA SQL');
END;
SELECT * FROM TB_PEDIDO;

EXEC SP_ClientePremiuM (30);
SELECT * FROM TABLOG;
SELECT * FROM TAB_ERRO;
